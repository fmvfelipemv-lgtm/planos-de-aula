<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano de Aula</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
        }
        .prose h1, .prose h2, .prose h3 {
            color: #1f2937;
            font-weight: 700;
            margin-top: 1.5em;
        }
        .prose h1.dark\:prose-invert, .prose h2.dark\:prose-invert, .prose h3.dark\:prose-invert {
            color: #f9fafb;
        }
        .prose ul, .prose ol {
            padding-left: 1.5em;
        }
        .prose li {
            margin-bottom: 0.5em;
        }
        .floating-item {
            animation: float-1 6s ease-in-out infinite;
        }
        .floating-item-2 {
            animation: float-2 8s ease-in-out infinite;
            animation-delay: 2s;
        }
        .floating-item-3 {
            animation: float-3 7s ease-in-out infinite;
            animation-delay: 1s;
        }
        @keyframes float-1 {
            0% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(15px, -20px) rotate(5deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }
        @keyframes float-2 {
            0% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(-10px, 25px) rotate(-8deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }
        @keyframes float-3 {
            0% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(20px, -15px) rotate(10deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-gray-900 overflow-hidden flex items-center justify-center p-4 relative">

    <div class="absolute top-10 left-5 text-9xl transform -rotate-12 floating-item">‚úèÔ∏è</div>
    <div class="absolute top-1/4 right-5 text-9xl transform rotate-12 floating-item-2">üìé</div>
    <div class="absolute bottom-10 left-1/4 text-9xl transform rotate-6 floating-item-3">üìè</div>
    <div class="absolute bottom-20 right-10 text-9xl transform -rotate-6 floating-item">üìì</div>
    <div class="absolute top-1/3 left-10 text-9xl transform -rotate-10 floating-item-2">‚úÇÔ∏è</div>
    <div class="absolute bottom-1/3 right-5 text-9xl transform rotate-5 floating-item">üé®</div>

    <div id="app-container" class="relative z-10 w-full flex items-center justify-center p-4"></div>

    <div class="absolute bottom-4 right-4 text-3xl font-bold text-gray-500 dark:text-gray-400">
        by FeMaViei
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const appContainer = document.getElementById('app-container');
            let currentPage = 'form';
            let formData = {
                subject: '',
                topic: '',
                gradeLevel: '',
                duration: '',
                objective: '',
                activities: '',
                materials: '',
                assessment: ''
            };
            let generatedPlan = '';
            let isLoading = false;
            let error = null;
            let copiedMessage = false;

            const checkLibraries = () => {
                return typeof html2canvas !== 'undefined' && typeof jspdf !== 'undefined';
            };

            const render = () => {
                appContainer.innerHTML = '';
                if (currentPage === 'form') {
                    renderForm();
                } else {
                    renderResult();
                }
            };

            const handleInputChange = (name, value) => {
                formData = { ...formData, [name]: value };
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                isLoading = true;
                error = null;
                render();
                
                await new Promise(resolve => setTimeout(resolve, 100));
                await generateLessonPlan();
            };

            const generateLessonPlan = async () => {
                const prompt = `Crie um plano de aula com base nestas informa√ß√µes:
Disciplina: ${formData.subject}
Conte√∫do: ${formData.topic}
S√©rie: ${formData.gradeLevel}
Dura√ß√£o: ${formData.duration} minutos
Objetivo: ${formData.objective}
Atividades: ${formData.activities}
Materiais: ${formData.materials}
Avalia√ß√£o: ${formData.assessment}

Formate com t√≠tulos em negrito usando **T√≠tulo:** e liste os itens.`;

                const maxRetries = 3;
                const baseDelay = 1000;

                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 30000);

                        // API alternativa mais confi√°vel
                        const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=AIzaSyC_3vL3r_placeholder_key', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{
                                        text: prompt
                                    }]
                                }]
                            }),
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            throw new Error(`Erro HTTP! status: ${response.status}`);
                        }

                        const result = await response.json();
                        const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                        if (text) {
                            generatedPlan = text;
                            currentPage = 'result';
                            break;
                        } else {
                            error = 'N√£o foi poss√≠vel gerar o plano de aula.';
                        }
                    } catch (err) {
                        error = `Erro: ${err.message}`;
                        if (i === maxRetries - 1) {
                            // Fallback: gerar um plano b√°sico localmente
                            generatedPlan = `**PLANO DE AULA**

**Disciplina:** ${formData.subject}
**Conte√∫do:** ${formData.topic}
**S√©rie:** ${formData.gradeLevel}
**Dura√ß√£o:** ${formData.duration} minutos

**OBJETIVOS**
${formData.objective}

**DESENVOLVIMENTO**
${formData.activities}

**MATERIAIS**
${formData.materials}

**AVALIA√á√ÉO**
${formData.assessment}

*Plano gerado localmente devido a problemas de conex√£o*`;
                            currentPage = 'result';
                        }
                    }
                }
                isLoading = false;
                render();
            };

            const handleCopy = () => {
                navigator.clipboard.writeText(generatedPlan).then(() => {
                    copiedMessage = true;
                    render();
                    setTimeout(() => {
                        copiedMessage = false;
                        render();
                    }, 2000);
                });
            };

            const handleShareWhatsApp = () => {
                const encodedText = encodeURIComponent(generatedPlan);
                window.open(`https://wa.me/?text=${encodedText}`, '_blank');
            };

            const handleSavePdf = async () => {
                if (!checkLibraries()) {
                    alert('Bibliotecas de PDF n√£o carregadas. Recarregue a p√°gina.');
                    return;
                }

                try {
                    const element = document.getElementById('plan-content');
                    const canvas = await html2canvas(element, {
                        scale: 2,
                        backgroundColor: '#ffffff'
                    });

                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    const imgWidth = 210;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                    pdf.save('plano-de-aula.pdf');
                    
                } catch (err) {
                    alert('Erro ao gerar PDF: ' + err.message);
                }
            };

            const parsePlan = (planText) => {
                const sections = [];
                const lines = planText.split('\n');
                let currentTitle = '';
                let currentContent = '';

                lines.forEach(line => {
                    const trimmedLine = line.trim();
                    if (trimmedLine.startsWith('**') && trimmedLine.endsWith('**')) {
                        if (currentTitle) {
                            sections.push({ 
                                title: currentTitle.replace(/\*\*/g, '').toUpperCase(), 
                                content: currentContent.trim() 
                            });
                        }
                        currentTitle = trimmedLine;
                        currentContent = '';
                    } else {
                        currentContent += line + '\n';
                    }
                });

                if (currentTitle) {
                    sections.push({ 
                        title: currentTitle.replace(/\*\*/g, '').toUpperCase(), 
                        content: currentContent.trim() 
                    });
                }

                return sections.length > 0 ? sections : [{ title: 'PLANO DE AULA', content: planText }];
            };

            const renderForm = () => {
                const formHTML = `
                    <form id="lesson-form" class="relative p-6 md:p-10 bg-white dark:bg-gray-800 rounded-3xl shadow-xl w-full max-w-2xl mx-auto space-y-6">
                        <h2 class="text-3xl font-bold text-gray-800 dark:text-white text-center mb-6">Plano de Aula</h2>
                        <div class="space-y-4">
                            ${Object.entries({
                                subject: 'Disciplina',
                                topic: 'Conte√∫do',
                                gradeLevel: 'P√∫blico-alvo / S√©rie',
                                duration: 'Dura√ß√£o (minutos)',
                                objective: 'Objetivo(s)',
                                activities: 'Desenvolvimento da Aula (Atividades)',
                                materials: 'Recursos e Materiais',
                                assessment: 'Avalia√ß√£o'
                            }).map(([key, label]) => `
                                <div>
                                    <label class="block text-gray-700 dark:text-gray-300 font-medium mb-2">${label}</label>
                                    ${key === 'duration' ? `
                                        <input type="number" name="${key}" value="${formData[key]}" 
                                            class="w-full p-3 border-2 border-gray-300 rounded-lg" required />
                                    ` : key === 'objective' || key === 'activities' || key === 'materials' || key === 'assessment' ? `
                                        <textarea name="${key}" 
                                            class="w-full p-3 border-2 border-gray-300 rounded-lg min-h-[100px]">${formData[key]}</textarea>
                                    ` : `
                                        <input type="text" name="${key}" value="${formData[key]}" 
                                            class="w-full p-3 border-2 border-gray-300 rounded-lg" required />
                                    `}
                                </div>
                            `).join('')}
                        </div>
                        ${error ? `<div class="text-red-500 bg-red-100 p-3 rounded-lg mt-4">${error}</div>` : ''}
                        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-200 mt-6">
                            ${isLoading ? 'Gerando...' : 'Gerar Plano de Aula'}
                        </button>
                    </form>
                `;
                appContainer.innerHTML = formHTML;

                document.getElementById('lesson-form').addEventListener('submit', handleSubmit);
                document.querySelectorAll('input, textarea').forEach(input => {
                    input.addEventListener('input', (e) => {
                        handleInputChange(e.target.name, e.target.value);
                    });
                });
            };

            const renderResult = () => {
                const parsedPlan = parsePlan(generatedPlan);
                const colors = ['bg-blue-100', 'bg-green-100', 'bg-yellow-100', 'bg-red-100', 'bg-purple-100', 'bg-pink-100', 'bg-indigo-100'];
                const darkColors = ['dark:bg-blue-800', 'dark:bg-green-800', 'dark:bg-yellow-800', 'dark:bg-red-800', 'dark:bg-purple-800', 'dark:bg-pink-800', 'dark:bg-indigo-800'];

                const resultHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-4xl mx-auto p-6">
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white text-center mb-6">Plano de Aula Gerado</h2>
                        <div id="plan-content" class="space-y-4">
                            ${parsedPlan.map((section, index) => `
                                <div class="p-4 rounded-xl ${colors[index % colors.length]} ${darkColors[index % darkColors.length]}">
                                    <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-2">${section.title}</h3>
                                    <div class="text-gray-700 dark:text-gray-300 whitespace-pre-line">${section.content}</div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="flex flex-wrap gap-3 justify-center mt-6">
                            <button onclick="handleCopy()" class="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                                üìã Copiar
                            </button>
                            <button onclick="handleShareWhatsApp()" class="bg-green-600 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                                üì± WhatsApp
                            </button>
                            <button onclick="handleSavePdf()" class="bg-red-600 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                                üìÑ PDF
                            </button>
                            <button onclick="currentPage = 'form'; render();" class="bg-gray-600 text-white px-4 py-2 rounded-lg">
                                ‚Ü© Voltar
                            </button>
                        </div>
                        ${copiedMessage ? '<div class="text-green-600 text-center mt-4">‚úì Copiado com sucesso!</div>' : ''}
                    </div>
                `;
                appContainer.innerHTML = resultHTML;
            };

            // Expor fun√ß√µes globalmente para os bot√µes
            window.handleCopy = handleCopy;
            window.handleShareWhatsApp = handleShareWhatsApp;
            window.handleSavePdf = handleSavePdf;

            render();
        });
    </script>
</body>
</html>
