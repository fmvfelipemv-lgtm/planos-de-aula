<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano de Aula</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
        }
        .prose h1, .prose h2, .prose h3 {
            color: #1f2937;
            font-weight: 700;
            margin-top: 1.5em;
        }
        .prose h1.dark\:prose-invert, .prose h2.dark\:prose-invert, .prose h3.dark\:prose-invert {
            color: #f9fafb;
        }
        .prose ul, .prose ol {
            padding-left: 1.5em;
        }
        .prose li {
            margin-bottom: 0.5em;
        }
        /* Custom styles for the background - notebook paper effect is removed from the body */
        .floating-item {
            animation: float-1 6s ease-in-out infinite;
        }
        .floating-item-2 {
            animation: float-2 8s ease-in-out infinite;
            animation-delay: 2s;
        }
        .floating-item-3 {
            animation: float-3 7s ease-in-out infinite;
            animation-delay: 1s;
        }
        @keyframes float-1 {
            0% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(15px, -20px) rotate(5deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }
        @keyframes float-2 {
            0% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(-10px, 25px) rotate(-8deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }
        @keyframes float-3 {
            0% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(20px, -15px) rotate(10deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-gray-900 overflow-hidden flex items-center justify-center p-4 relative">

    <!-- Animated school supply emojis -->
    <div class="absolute top-10 left-5 text-9xl transform -rotate-12 floating-item">‚úèÔ∏è</div>
    <div class="absolute top-1/4 right-5 text-9xl transform rotate-12 floating-item-2">üìé</div>
    <div class="absolute bottom-10 left-1/4 text-9xl transform rotate-6 floating-item-3">üìè</div>
    <div class="absolute bottom-20 right-10 text-9xl transform -rotate-6 floating-item">üìì</div>
    <div class="absolute top-1/3 left-10 text-9xl transform -rotate-10 floating-item-2">‚úÇÔ∏è</div>
    <div class="absolute bottom-1/3 right-5 text-9xl transform rotate-5 floating-item">üé®</div>

    <!-- The app container now has a plain background instead of a notebook effect -->
    <div id="app-container" class="relative z-10 w-full flex items-center justify-center p-4"></div>

    <!-- Signature -->
    <div class="absolute bottom-4 right-4 text-3xl font-bold text-gray-500 dark:text-gray-400">
        by FeMaViei
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const appContainer = document.getElementById('app-container');
            let currentPage = 'form';
            let formData = {
                subject: '',
                topic: '',
                gradeLevel: '',
                duration: '',
                objective: '',
                activities: '',
                materials: '',
                assessment: ''
            };
            let generatedPlan = '';
            let isLoading = false;
            let error = null;
            let copiedMessage = false;

            const render = () => {
                appContainer.innerHTML = '';
                if (currentPage === 'form') {
                    renderForm();
                } else {
                    renderResult();
                }
            };

            const handleInputChange = (name, value) => {
                formData = { ...formData, [name]: value };
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                isLoading = true;
                error = null;
                render();
                await generateLessonPlan();
            };

            const generateLessonPlan = async () => {
                const prompt = `
                    Voc√™ √© um assistente pedag√≥gico especializado em criar planos de aula. Sua tarefa √© elaborar um plano de aula completo e profissional, formatado com t√≠tulos em negrito (por exemplo, **Disciplina:**) e listas, a partir das seguintes informa√ß√µes fornecidas por um professor. N√£o inclua nenhuma introdu√ß√£o ou texto extra, apenas o plano de aula final.

                    **Informa√ß√µes para o Plano de Aula:**
                    - **Disciplina:** ${formData.subject}
                    - **Conte√∫do:** ${formData.topic}
                    - **P√∫blico-alvo / S√©rie:** ${formData.gradeLevel}
                    - **Dura√ß√£o:** ${formData.duration} minutos
                    - **Objetivo(s):** ${formData.objective}
                    - **Desenvolvimento da Aula (Atividades):** ${formData.activities}
                    - **Recursos e Materiais:** ${formData.materials}
                    - **Avalia√ß√£o:** ${formData.assessment}
                `;

                // URL do proxy que contorna o erro de CORS e autentica√ß√£o
                const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://us-central1-cors-proxy-ai-416919.cloudfunctions.net/proxy-gemini');
                
                const maxRetries = 3;
                const baseDelay = 1000;

                for (let i = 0; i < maxRetries; i++) {
                    try {
                        // Faz a requisi√ß√£o para o proxy, que redirecionar√° para o Gemini
                        const response = await fetch(proxyUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ prompt: prompt }) // Envia o prompt no formato que o proxy espera
                        });

                        if (response.status === 429) {
                            const delay = baseDelay * Math.pow(2, i);
                            console.log(`Limite de requisi√ß√µes excedido. Tentando novamente em ${delay / 1000} segundos...`);
                            await new Promise(res => setTimeout(res, delay));
                            continue;
                        }

                        if (!response.ok) {
                            throw new Error(`Erro HTTP! status: ${response.status}`);
                        }

                        const result = await response.json();
                        // A resposta do proxy j√° √© o texto gerado pelo Gemini
                        const text = result?.text || result?.candidates?.[0]?.content?.parts?.[0]?.text;

                        if (text) {
                            generatedPlan = text;
                            currentPage = 'result';
                        } else {
                            error = 'N√£o foi poss√≠vel gerar o plano de aula. A resposta da API foi inesperada.';
                            console.error("Resposta inesperada da API:", result);
                        }
                        break; // Sai do loop de tentativas se obteve sucesso ou um erro n√£o relacionado a rate limit

                    } catch (err) {
                        error = `Erro ao gerar o plano de aula: ${err.message}`;
                        console.error('Erro detalhado:', err);
                        // Se for a √∫ltima tentativa e ainda falhar, o erro ser√° mostrado para o usu√°rio
                        if (i === maxRetries - 1) {
                            error = `Falha ap√≥s ${maxRetries} tentativas. Erro: ${err.message}`;
                        }
                    }
                }
                isLoading = false;
                render();
            };

            const handleCopy = () => {
                const textarea = document.createElement('textarea');
                textarea.value = generatedPlan;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);

                copiedMessage = true;
                render();
                setTimeout(() => {
                    copiedMessage = false;
                    render();
                }, 2000);
            };

            const handleShareWhatsApp = () => {
                const encodedText = encodeURIComponent(generatedPlan);
                const whatsappUrl = `https://wa.me/?text=${encodedText}`;
                window.open(whatsappUrl, '_blank');
            };

            const handleSavePdf = async () => {
                const element = document.getElementById('plan-content');
                if (!element || typeof window.html2canvas === 'undefined' || typeof window.jspdf === 'undefined') {
                    const messageBox = document.createElement('div');
                    messageBox.textContent = 'As bibliotecas para salvar em PDF n√£o est√£o carregadas. Tente novamente em alguns segundos.';
                    messageBox.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background-color: #f87171;
                        color: white;
                        padding: 15px;
                        border-radius: 8px;
                        z-index: 1000;
                    `;
                    document.body.appendChild(messageBox);
                    setTimeout(() => {
                        document.body.removeChild(messageBox);
                    }, 3000);
                    return;
                }

                const canvas = await window.html2canvas(element, { scale: 2 });
                const imgData = canvas.toDataURL('image/png');

                const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
                const imgWidth = 210;
                const pageHeight = 297;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                pdf.save('plano-de-aula.pdf');
            };

            const parsePlan = (planText) => {
                const sections = [];
                const lines = planText.split('\n');
                let currentTitle = '';
                let currentContent = '';

                lines.forEach(line => {
                    const trimmedLine = line.trim();
                    if (trimmedLine.startsWith('**') && trimmedLine.endsWith('**') && trimmedLine.length > 4) {
                        if (currentTitle) {
                            sections.push({ title: currentTitle.toUpperCase(), content: currentContent.trim() });
                        }
                        currentTitle = trimmedLine.replace(/\*\*/g, '');
                        currentContent = '';
                    } else {
                        currentContent += line + '\n';
                    }
                });
                if (currentTitle) {
                    sections.push({ title: currentTitle.toUpperCase(), content: currentContent.trim() });
                }
                return sections;
            };

            const renderForm = () => {
                const formHTML = `
                    <form id="lesson-form" class="relative p-6 md:p-10 bg-white dark:bg-gray-800 rounded-3xl shadow-[8px_8px_0px_0px_#8B5CF6] dark:shadow-[8px_8px_0px_0px_#4C1D95] w-full max-w-2xl mx-auto space-y-5 md:space-y-8 transform transition-transform duration-300 hover:scale-105">
                        <h2 class="text-3xl font-bold text-gray-800 dark:text-white text-center mb-6">Plano de Aula</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300 font-medium mb-1" for="subject">Disciplina</label>
                                <input type="text" id="subject" name="subject" value="${formData.subject}" class="w-full p-3 rounded-xl border-2 border-purple-300 dark:border-purple-600 bg-purple-50 dark:bg-purple-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-purple-500" required />
                            </div>
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300 font-medium mb-1" for="topic">Conte√∫do</label>
                                <input type="text" id="topic" name="topic" value="${formData.topic}" class="w-full p-3 rounded-xl border-2 border-purple-300 dark:border-purple-600 bg-purple-50 dark:bg-purple-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-purple-500" required />
                            </div>
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300 font-medium mb-1" for="gradeLevel">P√∫blico-alvo / S√©rie</label>
                                <input type="text" id="gradeLevel" name="gradeLevel" value="${formData.gradeLevel}" class="w-full p-3 rounded-xl border-2 border-purple-300 dark:border-purple-600 bg-purple-50 dark:bg-purple-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-purple-500" required />
                            </div>
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300 font-medium mb-1" for="duration">Dura√ß√£o (minutos)</label>
                                <input type="number" id="duration" name="duration" value="${formData.duration}" class="w-full p-3 rounded-xl border-2 border-purple-300 dark:border-purple-600 bg-purple-50 dark:bg-purple-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-purple-500" required />
                            </div>
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300 font-medium mb-1" for="objective">Objetivo(s)</label>
                                <textarea id="objective" name="objective" class="w-full p-3 rounded-xl border-2 border-purple-300 dark:border-purple-600 bg-purple-50 dark:bg-purple-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-purple-500 min-h-[100px]" required>${formData.objective}</textarea>
                            </div>
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300 font-medium mb-1" for="activities">Desenvolvimento da Aula (Atividades)</label>
                                <textarea id="activities" name="activities" class="w-full p-3 rounded-xl border-2 border-purple-300 dark:border-purple-600 bg-purple-50 dark:bg-purple-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-purple-500 min-h-[150px]" required>${formData.activities}</textarea>
                            </div>
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300 font-medium mb-1" for="materials">Recursos e Materiais</label>
                                <textarea id="materials" name="materials" class="w-full p-3 rounded-xl border-2 border-purple-300 dark:border-purple-600 bg-purple-50 dark:bg-purple-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-purple-500 min-h-[100px]" required>${formData.materials}</textarea>
                            </div>
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300 font-medium mb-1" for="assessment">Avalia√ß√£o</label>
                                <textarea id="assessment" name="assessment" class="w-full p-3 rounded-xl border-2 border-purple-300 dark:border-purple-600 bg-purple-50 dark:bg-purple-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-purple-500 min-h-[100px]" required>${formData.assessment}</textarea>
                            </div>
                        </div>
                        ${error ? `<div class="text-red-500 mt-4 text-center">${error}</div>` : ''}
                        <div class="flex justify-center">
                            <button type="submit" class="w-full md:w-auto px-8 py-4 bg-purple-600 text-white font-bold rounded-full shadow-[4px_4px_0px_0px_#8B5CF6] dark:shadow-[4px_4px_0px_0px_#4C1D95] transition-all duration-100 disabled:opacity-50 disabled:cursor-not-allowed text-lg active:scale-95 active:shadow-none" ${isLoading ? 'disabled' : ''}>
                                ${isLoading ? 'Gerando...' : 'Gerar Plano de Aula'}
                            </button>
                        </div>
                    </form>
                `;
                appContainer.innerHTML = formHTML;

                const form = document.getElementById('lesson-form');
                form.addEventListener('submit', handleSubmit);

                Object.keys(formData).forEach(key => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input) {
                        input.addEventListener('input', (e) => {
                            handleInputChange(key, e.target.value);
                        });
                    }
                });
            };

            const renderResult = () => {
                const parsedPlan = parsePlan(generatedPlan);
                const colors = ['bg-pink-100', 'bg-teal-100', 'bg-purple-100', 'bg-yellow-100', 'bg-red-100', 'bg-blue-100', 'bg-green-100', 'bg-orange-100'];
                const darkColors = ['dark:bg-pink-800', 'dark:bg-teal-800', 'dark:bg-purple-800', 'dark:bg-yellow-800', 'dark:bg-red-800', 'dark:bg-blue-800', 'dark:bg-green-800', 'dark:bg-orange-800'];
                let colorIndex = 0;

                const sectionsHtml = parsedPlan.map((section, index) => {
                    const bgClass = colors[index % colors.length];
                    const darkBgClass = darkColors[index % darkColors.length];
                    return `
                        <div class="p-4 rounded-xl shadow-lg ${bgClass} ${darkBgClass} transform transition-transform duration-300 hover:scale-[1.02] animate-fade-in">
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">${section.title}</h3>
                            <div class="prose dark:prose-invert text-lg text-gray-900 dark:text-gray-100 overflow-auto">
                                ${section.content.replace(/\n/g, '<br />')}
                            </div>
                        </div>
                    `;
                }).join('');

                const resultHTML = `
                    <div class="p-4 md:p-8 bg-gray-100 dark:bg-gray-900 rounded-2xl shadow-xl w-full max-w-4xl mx-auto space-y-4">
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white text-center mb-6">Plano de Aula</h2>
                        <div id="plan-content" class="space-y-4">
                            ${sectionsHtml}
                        </div>
                        <div class="flex flex-col md:flex-row justify-center gap-4 mt-6">
                            ${copiedMessage ? '<span class="text-green-500 text-center font-bold">Copiado!</span>' : ''}
                            <button id="copy-btn" class="flex items-center justify-center px-6 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition duration-300">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v12a2 2 0 01-2 2h-4m-6 0h6"></path></svg>
                                Copiar Plano
                            </button>
                            <button id="whatsapp-btn" class="flex items-center justify-center px-6 py-3 bg-green-500 text-white font-bold rounded-xl shadow-lg hover:bg-green-600 transition duration-300">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12.039 2.031c-5.46 0-9.923 4.462-9.923 9.923 0 1.964.57 3.896 1.637 5.584l-1.688 6.166 6.309-1.642a9.923 9.923 0 005.584 1.637c5.46 0 9.923-4.462 9.923-9.923.001-5.461-4.461-9.923-9.922-9.923zm5.227 12.569c-.29-.145-1.706-.841-1.972-.942-.266-.1-.46-.145-.653.145-.194.29-.75.942-.922 1.135-.172.194-.345.218-.635.073-.29-.145-1.22-.449-2.324-1.432-.87-.77-1.458-1.729-1.63-2.02-.172-.29-.017-.272.127-.417.114-.114.26-.29.387-.435.127-.145.171-.242.26-.435.09-.194.043-.362-.021-.507-.065-.145-.58-.871-.795-1.18-.216-.31-.433-.26-.635-.26-.194 0-.41.025-.635.025-.224 0-.58.073-.883.417-.303.345-1.157 1.136-1.157 2.768 0 1.632 1.18 3.204 1.344 3.422.164.218 2.302 3.664 5.58 4.717 3.278 1.054 3.278.71 3.865.654.588-.057 1.705-.694 1.948-1.353.243-.66.243-.615.178-.76z"/></svg>
                                Compartilhar pelo WhatsApp
                            </button>
                            <button id="save-pdf-btn" class="flex items-center justify-center px-6 py-3 bg-red-600 text-white font-bold rounded-xl shadow-lg hover:bg-red-700 transition duration-300">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                Salvar como PDF
                            </button>
                            <button id="back-btn" class="w-full md:w-auto px-6 py-3 bg-gray-400 text-white font-bold rounded-xl shadow-lg hover:bg-gray-500 transition duration-300">
                                Voltar
                            </button>
                        </div>
                    </div>
                `;
                appContainer.innerHTML = resultHTML;

                document.getElementById('copy-btn').addEventListener('click', handleCopy);
                document.getElementById('whatsapp-btn').addEventListener('click', handleShareWhatsApp);
                document.getElementById('save-pdf-btn').addEventListener('click', handleSavePdf);
                document.getElementById('back-btn').addEventListener('click', () => {
                    currentPage = 'form';
                    generatedPlan = '';
                    render();
                });
            };

            render();
        });
    </script>
</body>
</html>
