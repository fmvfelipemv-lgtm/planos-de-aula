<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano de Aula Inteligente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
        }
        .floating-item {
            animation: float-1 6s ease-in-out infinite;
        }
        .floating-item-2 {
            animation: float-2 8s ease-in-out infinite;
            animation-delay: 2s;
        }
        .floating-item-3 {
            animation: float-3 7s ease-in-out infinite;
            animation-delay: 1s;
        }
        @keyframes float-1 {
            0% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(15px, -20px) rotate(5deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }
        @keyframes float-2 {
            0% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(-10px, 25px) rotate(-8deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }
        @keyframes float-3 {
            0% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(20px, -15px) rotate(10deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }
        .loader {
            border-top-color: #8B5CF6;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-gray-900 overflow-y-auto flex items-center justify-center p-4 relative">

    <div class="absolute top-10 left-5 text-9xl transform -rotate-12 floating-item">‚úèÔ∏è</div>
    <div class="absolute top-1/4 right-5 text-9xl transform rotate-12 floating-item-2">üìé</div>
    <div class="absolute bottom-10 left-1/4 text-9xl transform rotate-6 floating-item-3">üìè</div>
    <div class="absolute bottom-20 right-10 text-9xl transform -rotate-6 floating-item">üìì</div>
    <div class="absolute top-1/3 left-10 text-9xl transform -rotate-10 floating-item-2">‚úÇÔ∏è</div>
    <div class="absolute bottom-1/3 right-5 text-9xl transform rotate-5 floating-item">üé®</div>

    <div id="app-container" class="relative z-10 w-full flex items-center justify-center p-4 my-8"></div>

    <div class="absolute bottom-4 right-4 text-3xl font-bold text-gray-500 dark:text-gray-400">
        by FeMaViei
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const appContainer = document.getElementById('app-container');
            let currentPage = 'form';
            let formData = {
                subject: '',
                topic: '',
                gradeLevel: '',
                duration: '',
                objective: '',
                activities: '',
                materials: '',
                assessment: ''
            };
            let generatedPlan = '';
            let isLoading = false;
            let error = null;
            let copiedMessage = false;
            let apiKey = ''; // Ser√° preenchida pelo usu√°rio

            const render = () => {
                appContainer.innerHTML = '';
                if (currentPage === 'form') {
                    renderForm();
                } else if (currentPage === 'apiKey') {
                    renderApiKeyForm();
                } else {
                    renderResult();
                }
            };

            const handleInputChange = (name, value) => {
                formData = { ...formData, [name]: value };
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                if (!apiKey) {
                    currentPage = 'apiKey';
                    render();
                    return;
                }
                
                isLoading = true;
                error = null;
                render();
                
                await generateLessonPlan();
            };

            const handleApiKeySubmit = (e) => {
                e.preventDefault();
                const keyInput = document.getElementById('api-key');
                apiKey = keyInput.value.trim();
                currentPage = 'form';
                render();
            };

            const generateLessonPlan = async () => {
                try {
                    // Verificar se temos uma chave API
                    if (!apiKey) {
                        throw new Error('Chave API n√£o configurada');
                    }

                    // Gerar prompt para a API
                    const prompt = `Gere um plano de aula detalhado em portugu√™s com os seguintes par√¢metros:
                    - Disciplina: ${formData.subject}
                    - Tema: ${formData.topic}
                    - S√©rie/Ano: ${formData.gradeLevel}
                    - Dura√ß√£o: ${formData.duration} minutos
                    - Objetivo: ${formData.objective || 'N√£o especificado'}
                    - Atividades: ${formData.activities || 'N√£o especificadas'}
                    - Materiais: ${formData.materials || 'N√£o especificados'}
                    - Avalia√ß√£o: ${formData.assessment || 'N√£o especificada'}
                    
                    Formate a resposta em markdown com se√ß√µes para:
                    **DISCIPLINA**, **TEMA**, **S√âRIE/ANO**, **DURA√á√ÉO**, 
                    **OBJETIVOS ESPEC√çFICOS**, **RECURSOS DID√ÅTICOS**, 
                    **INSTRUMENTOS DE AVALIA√á√ÉO**, **REFER√äNCIAS BIBLIOGR√ÅFICAS** e **OBSERVA√á√ïES**.
                    
                    Forne√ßa um plano de aula completo, criativo e adequado para o n√≠vel educacional especificado.`;

                    // Fazer requisi√ß√£o para a API OpenAI
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: [
                                {
                                    role: 'system',
                                    content: 'Voc√™ √© um assistente especializado em educa√ß√£o que gera planos de aula detalhados e criativos em portugu√™s.'
                                },
                                {
                                    role: 'user',
                                    content: prompt
                                }
                            ],
                            temperature: 0.7,
                            max_tokens: 2000
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || 'Erro ao conectar com a API');
                    }

                    const data = await response.json();
                    generatedPlan = data.choices[0].message.content;
                    currentPage = 'result';
                } catch (err) {
                    error = 'Erro ao gerar plano: ' + err.message;
                    // Fallback para plano local em caso de erro
                    if (err.message.includes('API') || err.message.includes('conectar')) {
                        generatedPlan = generateLocalPlan(formData);
                        currentPage = 'result';
                    }
                }
                isLoading = false;
                render();
            };

            const generateLocalPlan = (data) => {
                const { subject, topic, gradeLevel, duration, objective, activities, materials, assessment } = data;
                
                return `**PLANO DE AULA COMPLETO**

**DISCIPLINA:** ${subject.toUpperCase()}
**TEMA:** ${topic}
**S√âRIE/ANO:** ${gradeLevel}
**DURA√á√ÉO:** ${duration} minutos (${Math.floor(duration/60)}h${duration%60}min)

**OBJETIVOS ESPEC√çFICOS**
‚Ä¢ Compreender o conceito de ${topic.toLowerCase()}
‚Ä¢ Identificar ${topic.toLowerCase()} em diferentes contextos
‚Ä¢ Aplicar os conhecimentos sobre ${topic.toLowerCase()} em situa√ß√µes pr√°ticas
‚Ä¢ Desenvolver habilidades de an√°lise e interpreta√ß√£o
‚Ä¢ ${objective || 'Promover aprendizagem significativa'}

**RECURSOS DID√ÅTICOS**
‚Ä¢ ${materials || 'Materiais b√°sicos de ensino'}
‚Ä¢ Quadro branco ou negro
‚Ä¢ Projetor multim√≠dia (se dispon√≠vel)
‚Ä¢ Materiais impressos e apostilas
‚Ä¢ Recursos audiovisuais complementares

**INSTRUMENTOS DE AVALIA√á√ÉO**
‚Ä¢ ${assessment || 'Avalia√ß√£o cont√≠nua do processo'}
‚Ä¢ Participa√ß√£o nas atividades propostas
‚Ä¢ Resolu√ß√£o dos exerc√≠cios pr√°ticos
‚Ä¢ Observa√ß√£o do engajamento durante as explica√ß√µes
‚Ä¢ Autoavalia√ß√£o dos estudantes

**REFER√äNCIAS BIBLIOGR√ÅFICAS**
‚Ä¢ Livros did√°ticos da disciplina
‚Ä¢ Materiais complementares espec√≠ficos
‚Ä¢ Recursos educacionais digitais
‚Ä¢ Documentos oficiais da base curricular

**OBSERVA√á√ïES**
‚Ä¢ Ajustar o tempo conforme o ritmo da turma
‚Ä¢ Considerar as particularidades dos estudantes
‚Ä¢ Manter ambiente prop√≠cio para aprendizagem
‚Ä¢ Promover inclus√£o e participa√ß√£o de todos

*Plano pedag√≥gico gerado automaticamente - ${new Date().toLocaleDateString('pt-BR')}*`;
            };

            const handleCopy = () => {
                navigator.clipboard.writeText(generatedPlan).then(() => {
                    copiedMessage = true;
                    render();
                    setTimeout(() => {
                        copiedMessage = false;
                        render();
                    }, 2000);
                });
            };

            const handleShareWhatsApp = () => {
                const encodedText = encodeURIComponent(generatedPlan);
                window.open(`https://wa.me/?text=${encodedText}`, '_blank');
            };

            const handleSavePdf = async () => {
                try {
                    const element = document.getElementById('plan-content');
                    const canvas = await html2canvas(element, {
                        scale: 2,
                        backgroundColor: '#ffffff'
                    });

                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    const imgWidth = 210;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                    pdf.save('plano-de-aula.pdf');
                    
                } catch (err) {
                    alert('Erro ao gerar PDF: ' + err.message);
                }
            };

            const parsePlan = (planText) => {
                const sections = [];
                const lines = planText.split('\n');
                let currentTitle = '';
                let currentContent = '';

                lines.forEach(line => {
                    const trimmedLine = line.trim();
                    if (trimmedLine.startsWith('**') && trimmedLine.endsWith('**')) {
                        if (currentTitle) {
                            sections.push({ 
                                title: currentTitle.replace(/\*\*/g, ''), 
                                content: currentContent.trim() 
                            });
                        }
                        currentTitle = trimmedLine;
                        currentContent = '';
                    } else {
                        currentContent += line + '\n';
                    }
                });

                if (currentTitle) {
                    sections.push({ 
                        title: currentTitle.replace(/\*\*/g, ''), 
                        content: currentContent.trim() 
                    });
                }

                return sections.length > 0 ? sections : [{ title: 'PLANO DE AULA', content: planText }];
            };

            const renderApiKeyForm = () => {
                const apiKeyHTML = `
                    <form id="api-key-form" class="relative p-6 md:p-10 bg-white dark:bg-gray-800 rounded-3xl shadow-xl w-full max-w-2xl mx-auto space-y-6">
                        <h2 class="text-3xl font-bold text-gray-800 dark:text-white text-center mb-6">Configura√ß√£o de API</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300 font-medium mb-2">
                                    Chave da API OpenAI
                                </label>
                                <input 
                                    type="password" 
                                    id="api-key" 
                                    class="w-full p-3 border-2 border-gray-300 rounded-lg" 
                                    placeholder="Insira sua chave API da OpenAI" 
                                    required 
                                />
                                <p class="text-sm text-gray-500 mt-2">
                                    Sua chave API √© necess√°ria para gerar planos de aula personalizados. 
                                    N√£o armazenamos sua chave - ela √© usada apenas para esta sess√£o.
                                </p>
                            </div>
                        </div>
                        ${error ? `<div class="text-red-500 bg-red-100 p-3 rounded-lg mt-4">${error}</div>` : ''}
                        <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition duration-200 mt-6">
                            Salvar e Continuar
                        </button>
                    </form>
                `;
                appContainer.innerHTML = apiKeyHTML;

                const form = document.getElementById('api-key-form');
                form.onsubmit = handleApiKeySubmit;
            };

            const renderForm = () => {
                const formHTML = `
                    <form id="lesson-form" class="relative p-6 md:p-10 bg-white dark:bg-gray-800 rounded-3xl shadow-xl w-full max-w-2xl mx-auto space-y-6">
                        <h2 class="text-3xl font-bold text-gray-800 dark:text-white text-center mb-6">Plano de Aula Inteligente</h2>
                        <div class="space-y-4">
                            ${Object.entries({
                                subject: 'Disciplina',
                                topic: 'Conte√∫do/Tema',
                                gradeLevel: 'S√©rie/Ano',
                                duration: 'Dura√ß√£o (minutos)',
                                objective: 'Objetivo(s)',
                                activities: 'Atividades',
                                materials: 'Materiais',
                                assessment: 'Avalia√ß√£o'
                            }).map(([key, label]) => `
                                <div>
                                    <label class="block text-gray-700 dark:text-gray-300 font-medium mb-2">${label}</label>
                                    ${key === 'duration' ? `
                                        <input type="number" name="${key}" value="${formData[key]}" 
                                            class="w-full p-3 border-2 border-gray-300 rounded-lg" required />
                                    ` : key === 'objective' || key === 'activities' || key === 'materials' || key === 'assessment' ? `
                                        <textarea name="${key}" 
                                            class="w-full p-3 border-2 border-gray-300 rounded-lg min-h-[100px]">${formData[key]}</textarea>
                                    ` : `
                                        <input type="text" name="${key}" value="${formData[key]}" 
                                            class="w-full p-3 border-2 border-gray-300 rounded-lg" required />
                                    `}
                                </div>
                            `).join('')}
                        </div>
                        ${error ? `<div class="text-red-500 bg-red-100 p-3 rounded-lg mt-4">${error}</div>` : ''}
                        <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition duration-200 mt-6 flex items-center justify-center">
                            ${isLoading ? '<div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 mr-2"></div> Gerando...' : 'Gerar Plano de Aula'}
                        </button>
                    </form>
                `;
                appContainer.innerHTML = formHTML;

                const form = document.getElementById('lesson-form');
                form.onsubmit = handleSubmit;

                // Adicionar event listeners para os inputs
                form.querySelectorAll('input, textarea').forEach(input => {
                    input.oninput = (e) => handleInputChange(e.target.name, e.target.value);
                });
            };

            const renderResult = () => {
                const parsedPlan = parsePlan(generatedPlan);
                const colors = ['bg-blue-100', 'bg-green-100', 'bg-yellow-100', 'bg-red-100', 'bg-purple-100', 'bg-pink-100'];
                const darkColors = ['dark:bg-blue-800', 'dark:bg-green-800', 'dark:bg-yellow-800', 'dark:bg-red-800', 'dark:bg-purple-800', 'dark:bg-pink-800'];

                const resultHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-4xl mx-auto p-6">
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white text-center mb-6">Plano de Aula Gerado</h2>
                        <div id="plan-content" class="space-y-4">
                            ${parsedPlan.map((section, index) => `
                                <div class="p-6 rounded-xl ${colors[index % colors.length]} ${darkColors[index % darkColors.length]}">
                                    <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-3">${section.title}</h3>
                                    <div class="text-gray-700 dark:text-gray-300 whitespace-pre-line leading-relaxed">
                                        ${section.content}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="flex flex-wrap gap-3 justify-center mt-8">
                            <button id="copy-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                                üìã Copiar
                            </button>
                            <button id="whatsapp-btn" class="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition">
                                üì± WhatsApp
                            </button>
                            <button id="pdf-btn" class="bg-red-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-700 transition">
                                üìÑ Salvar PDF
                            </button>
                            <button id="back-btn" class="bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-700 transition">
                                ‚Ü© Voltar
                            </button>
                        </div>
                        ${copiedMessage ? '<div class="text-green-600 text-center mt-4 font-semibold">‚úì Copiado para a √°rea de transfer√™ncia!</div>' : ''}
                    </div>
                `;
                appContainer.innerHTML = resultHTML;

                // Adicionar event listeners corretamente
                document.getElementById('copy-btn').onclick = handleCopy;
                document.getElementById('whatsapp-btn').onclick = handleShareWhatsApp;
                document.getElementById('pdf-btn').onclick = handleSavePdf;
                document.getElementById('back-btn').onclick = () => {
                    currentPage = 'form';
                    render();
                };
            };

            render();
        });
    </script>
</body>
</html>
